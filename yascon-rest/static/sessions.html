<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="./content.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<body>
    <div id="app">
        <h2>Sessions</h2>
        <table width="80%">
            <tr>
                <th width="15%">Start Date/Time</th>
                <th width="70%">Presentation Name</th>
                <th width="15%">Venue Name</th>
                <th width="3%">Duration Minutes</th>
            </tr>
            <tr v-for="session in sessions" :key="session.id">
                <td><input type="text" :value="fromEpochMinute(session.start_time_min)" readonly></td>
                <td><input type="text" v-model="session.presentation.name" readonly></td>
                <td><input type="text" v-model="session.venue.name" readonly></td>
                <td><input type="text" v-model.number="session.duration_mins" @blur="updateSession(session)"></td>
                <td><button @click="sessionAttendees(session.id)">Attendees</button></td>
                <td><button @click="deleteSession(session.id)">Delete</button></td>
            </tr>
            <tr>
                <td>
                    <input ref="datepickerInput" type="text" placeholder="YYYY-MM-DD HH:mm" class="w-full" />
                </td>
                <td>
                    <select v-model="newSession.presentations_id">
                        <option value="0"></option>
                        <option v-for="presentation in presentations" :key="presentation.id" :value="presentation.id">
                            {{ presentation.name }}
                        </option>
                    </select>
                </td>
                <td>
                    <select v-model="newSession.venues_id">
                        <option value="0"></option>
                        <option v-for="venue in venues" :key="venue.id" :value="venue.id">
                            {{ venue.name }}
                        </option>
                    </select>
                </td>
                <td><input type="text" v-model.number="newSession.duration_mins"></td>
                <td><button @click="createSession()">Add</button></td>
            </tr>
        </table>
    </div>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    sessions: [],
                    newSession: { },
                    selectedPresentationName: '',
                    presentations: [],
                    venues: [],
                    selectedVenueName: '',
                    flatpickrInstance: null,
                }
            },
            methods: {
                
                async fetchSessions() {
                    const res = await fetch('/sessions?venue=name&presentation=name');
                    this.sessions = await res.json();
                },

                async fetchPresentations() {
                    const res = await fetch('/presentations');
                    this.presentations = await res.json();
                },

                async fetchVenues() {
                    const res = await fetch('/venues');
                    this.venues = await res.json();
                },

                async createSession() {
                    if (!this.newSession.duration_mins && !flatpickrInstance.selectedDates) return

                    this.newSession.start_time_min = this.toEpochMinute(flatpickrInstance.selectedDates[0])

                    const res = await fetch('/sessions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newSession)
                    });
                    document.location.reload()
                },

                async updateSession(session) {
                    await fetch(`/sessions/${session.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(session)
                    });
                },

                async deleteSession(id) {
                    await fetch(`/sessions/${id}`, { method: 'DELETE' });
                    document.location.reload()
                },

                toEpochMinute(date) {
                    return Math.floor((date.getTime() / 60000) - + date.getTimezoneOffset())
                },

                fromEpochMinute(epoch) {
                    const date = new Date()
                    date.setTime((epoch + date.getTimezoneOffset()) * 60000) // JS Date wants ms
                    const year = date.getFullYear()
                    const month = String(date.getMonth() + 1).padStart(2, "0")
                    const day = String(date.getDate()).padStart(2, "0")
                    const hour = String(date.getHours()).padStart(2, "0")
                    const minute = String(date.getMinutes()).padStart(2, "0")
                    return `${year}-${month}-${day} ${hour}:${minute}`;
                },

                sessionAttendees(id) {
                    window.location.href = `./session.html?${id}`
                },
            },
            async mounted() {
                this.fetchSessions()
                this.fetchPresentations()
                this.fetchVenues()

                flatpickrInstance = flatpickr(this.$refs.datepickerInput, {
                    dateFormat: 'Y-m-d H:i',
                    enableTime: true,
                })
            }
        }).mount("#app");
    </script>
</body>

</html>