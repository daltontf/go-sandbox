<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

        <script>
            function sessions() {
                return {
                    sessions: [],
                    newSession: { presentation: {}, venue: {}},
                    selectedPresentationName: '',
                    presentations: [],
                    venues: [],
                    selectedVenueName: '',
                    flatpickrInstance: null,
                    currentDate: "",

                    async fetchSessions() {
                        const res = await fetch('/sessions?venue=name&presentation=name');
                        this.sessions = await res.json();
                    },

                    async fetchPresentations() {
                        const res = await fetch('/presentations');
                        this.presentations = await res.json();
                    },

                    async fetchVenues() {
                        const res = await fetch('/venues');
                        this.venues = await res.json();
                    },

                    async createSession() {
                        if (!this.newSession.duration_mins) return

                        this.newSession.start_time_min = this.toEpochMinute(this.currentDate)

                        const res = await fetch('/sessions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newSession)
                        });

                        this.sessions.push({
                            "id": parseInt(res.headers.get("Location").match(/(\d+)$/)[1]),
                            "start_time_min": this.newSession.start_time_min,
                            "duration_mins": this.newSession.duration_mins,
                            "presentation": {
                                "name": this.selectedPresentationName
                            },
                            "venue": {
                                "name": this.selectedVenueName
                            } 
                        });
                    },

                    async updateSession(session) {
                        await fetch(`/sessions/${session.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(session)
                        });
                    },

                    async deleteSession(id) {
                        await fetch(`/sessions/${id}`, { method: 'DELETE' });
                        this.sessions = this.sessions.filter(i => i.id !== id);
                    },

                    toEpochMinute(dateStr) {
                        // Replace space with 'T' so it's valid ISO-8601
                        const date = new Date(dateStr.replace(" ", "T") + ":00Z")
                        return Math.floor((date.getTime() / 60000))
                    },

                    fromEpochMinute(epoch) {
                        const date = new Date()
                        date.setTime((epoch + date.getTimezoneOffset()) * 60000) // JS Date wants ms
                        const year = date.getFullYear()
                        const month = String(date.getMonth() + 1).padStart(2, "0")
                        const day = String(date.getDate()).padStart(2, "0")
                        const hour = String(date.getHours()).padStart(2, "0")
                        const minute = String(date.getMinutes()).padStart(2, "0")
                        return `${year}-${month}-${day} ${hour}:${minute}`;
                    },  

                    init() {
                        this.fetchSessions()
                        this.fetchPresentations()
                        this.fetchVenues()
                    }   
                }
            }
        </script>
    </head>
    <body>
        <div x-data="sessions()">
            <h2>Sessions</h2>
            <table>
                <tr>
                    <th>Presentation Name</th>
                    <th>Venue Name</th>
                    <th>Start Date/Time</th>
                    <th>Duration Minutes</th>
                </tr>
                <template x-for="session in sessions" :key="session.id">
                    <tr>
                        <td><input type="text" x-model="session.presentation.name" readonly></td>   
                        <td><input type="text" x-model="session.venue.name" readonly></td>    
                        <td><input type="text" :value="fromEpochMinute(session.start_time_min)" readonly></td>
                        <td><input type="text" x-model="session.duration_mins" readonly></td>  
                        <td><button @click="deleteSession(session.id)">Delete</button></td>
                    </tr>
                </template>
                <tr>
                    <td>
                        <select x-ref="presentationSelect" x-model.number="newSession.presentations_id" @change="selectedPresentationName = $refs.presentationSelect.options[$refs.presentationSelect.selectedIndex].text">
                            <option value="0"></option>
                            <template x-for="presentation in presentations" :key="presentation.id">
                              <option :value="presentation.id" x-text="presentation.name"></option>
                            </template>
                          </select>
                    </td>
                    <td>
                        <select x-ref="venueSelect" x-model.number="newSession.venues_id" @change="selectedVenueName = $refs.venueSelect.options[$refs.venueSelect.selectedIndex].text">
                            <option value="0"></option>
                            <template x-for="venue in venues" :key="venue.id">
                              <option :value="venue.id" x-text="venue.name"></option>
                            </template>
                          </select>
                    </td>
                    <td><div
                        x-init="
                          flatpickrInstance = flatpickr($refs.dateInput, {
                            dateFormat: 'Y-m-d H:i',
                            enableTime: true,
                            onChange: (selectedDates, dateStr, _) => {
                              currentDate = dateStr;
                            }
                            
                          })"                        
                      >
                      <input x-ref="dateInput" type="text" placeholder="YYYY-MM-DD HH:mm" class="w-full" />                      
                    </div></td>
                    <td><input type="text" x-model.number="newSession.duration_mins"></td>  
                    <td><button @click="createSession()">Add</button></td>
                </tr>    
            </table>
        </div>
    </body>
</html>