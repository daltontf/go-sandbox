<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="./content.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>

<body>
    <div id="app">
        <h2>{{attendee.name}}</h2>
        <table width="80%">
            <tr>
                <th width="40%">Presentation</th>
                <th width="20%">Venue</th>
                <th width="15%">Start Date/Time</th>
                <th width="3%">Duration Minutes</th>
            </tr>
            <tr v-for="attendeeSession in attendeeSessions" :key="attendeeSession.id">
                <td><input type="text" v-model="attendeeSession.presentation.name" readonly></td>
                <td><input type="text" v-model="attendeeSession.venue.name" readonly></td>
                <td><input type="text" :value="fromEpochMinute(attendeeSession.start_time_min)" readonly></td>
                <td><input type="text" v-model="attendeeSession.duration_mins" readonly></td>
                <td><button @click="deleteAttendeeSession(attendeeSession.id)">Delete</button></td>
                <td><button @click="showSessionAttendees(attendeeSession.id)">Session</button></td>
            </tr>
            <tr>
                <td colspan="4">
                    <select v-model="newAttendeeSession.id">
                        <option value="0"></option>
                        <option v-for="session in sessions" :key="session.id" :value="session.id">
                          {{session.presentation.name + ' - ' + session.venue.name + ' - ' + fromEpochMinute(session.start_time_min) + ' - ' + session.duration_mins}}
                        </option>
                    </select>
                </td>
                <td><button @click="createAttendeeSession()">Add</button></td>
            </tr>
        </table>
    </div>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    attendee: {},
                    sessions: [],
                    attendeeSessions: [],
                    newAttendeeSession: {}
                }
            },
            async mounted() {
                this.attendee.id = window.location.search.substring(1)

                const attendeeData = await fetch(`/attendees/${this.attendee.id}`);
                const attendeeSessionsData = await fetch(`/attendees/${this.attendee.id}/sessions`);
                const sessionsData = await fetch('/sessions?venue=name&presentation=name');

                const allSessions = await sessionsData.json();

                this.attendeeSessions = await attendeeSessionsData.json();

                const sessionSet = new Set(this.attendeeSessions.map(it => it.id));

                this.sessions = allSessions.filter(session => !sessionSet.has(session.id));

                this.attendee = await attendeeData.json();
            },
            methods: {
                async createAttendeeSession() {
                    if (this.newAttendeeSession.id) {
                        const res = await fetch(`/attendees/${this.attendee.id}/sessions/${this.newAttendeeSession.id}`, {
                            method: 'PUT',
                        });

                        document.location.reload()
                    }
                },

                async deleteAttendeeSession(id) {
                    await fetch(`/attendees/${this.attendee.id}/sessions/${id}`, { method: 'DELETE' });
                    document.location.reload()
                },

                fromEpochMinute(epoch) {
                    const date = new Date()
                    date.setTime((epoch + date.getTimezoneOffset()) * 60000) // JS Date wants ms
                    const year = date.getFullYear()
                    const month = String(date.getMonth() + 1).padStart(2, "0")
                    const day = String(date.getDate()).padStart(2, "0")
                    const hour = String(date.getHours()).padStart(2, "0")
                    const minute = String(date.getMinutes()).padStart(2, "0")
                    return `${year}-${month}-${day} ${hour}:${minute}`;
                },

                showSessionAttendees(id) {
                    window.location.href = `./session.html?${id}`
                },
            }
        }).mount("#app")
    </script>
</body>

</html>