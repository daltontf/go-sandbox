<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
        <script>
            function venues() {
                return {
                    venues: [],
                    newVenue: { name: '' },

                    async fetchVenues() {
                        const res = await fetch('/venues');
                        this.venues = await res.json();
                    },

                    async createVenue() {
                        if (!this.newVenue.name) venues;
                        const res = await fetch('/venues', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newVenue)
                        });
                        this.venues.push({
                            "id": parseInt(res.headers.get("Location").match(/(\d+)$/)[1]),
                            "name": this.newVenue.name,    
                            "capacity": parseInt(this.newVenue.capacity)
                        });
                        this.newVenue.name = ''
                        this.newVenue.capacity = 100
                    },

                    async updateVenue(venue) {
                        await fetch(`/venues/${venue.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(venue)
                        });
                    },

                    async deleteVenue(id) {
                        await fetch(`/venues/${id}`, { method: 'DELETE' });
                        this.venues = this.venues.filter(i => i.id !== id);
                    },

                    init() {
                        this.fetchVenues();
                    }   
                }
            }
        </script>
    </head>
    <body>
        <div x-data="venues()">
            <h2>Venues</h2>
            <table>
                <template x-for="venue in venues" :key="venue.id">
                    <tr>
                        <td><input type="text" x-model="venue.name" @blur="updateVenue(venue)"></td>
                        <td><input type="text" x-model.number="venue.capacity" @blur="updateVenue(venue)"></td>    
                        <td><button @click="deleteVenue(venue.id)">Delete</button></td>
                    </tr>
                </template>
                <tr>
                    <td><input type="text" placeholder="Venue name" x-model="newVenue.name"></td>
                    <td><input type="text" placeholder="100" x-model.number="newVenue.capacity"></td>
                    <td><button @click="createVenue()">Add</button></td>
                </tr>    
            </table>
        </div>
    </body>
</html>